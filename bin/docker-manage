#!/bin/bash

# Docker production helper script for gitlab-notifier

set -e

case "$1" in
  "up")
    echo "ğŸš€ Starting all services in production mode..."
    docker compose up --build
    ;;
  "down")
    echo "ğŸ›‘ Stopping all services..."
    docker compose down
    ;;
  "logs")
    echo "ğŸ“‹ Showing logs for $2..."
    docker compose logs -f ${2:-web}
    ;;
  "console")
    echo "ğŸ’» Opening Rails console..."
    docker compose exec web bin/rails console
    ;;
  "migrate")
    echo "ğŸ—„ï¸  Running database migrations..."
    docker compose exec web bin/rails db:migrate
    ;;
  "setup")
    echo "ğŸ”§ Setting up the application..."
    echo "Creating database..."
    docker compose exec web bin/rails db:create
    echo "Running migrations..."
    docker compose exec web bin/rails db:migrate
    echo "âœ… Setup complete!"
    ;;
  "clean")
    echo "ğŸ§¹ Cleaning up containers and volumes..."
    docker compose down -v
    docker system prune -f
    echo "âœ… Cleanup complete!"
    ;;
  "build")
    echo "ğŸ”¨ Building production images..."
    docker compose build --no-cache
    echo "âœ… Build complete!"
    ;;
  *)
    echo "Usage: $0 {up|down|logs|console|migrate|setup|clean|build}"
    echo ""
    echo "Commands:"
    echo "  up       - Start all services in production mode"
    echo "  down     - Stop all services"
    echo "  logs     - Show logs (optionally specify service: web, sidekiq, postgresql, redis)"
    echo "  console  - Open Rails console"
    echo "  migrate  - Run database migrations"
    echo "  setup    - Initial setup (create DB + migrate)"
    echo "  clean    - Clean up containers and volumes"
    echo "  build    - Build production images"
    echo ""
    echo "Application will be available at: http://localhost"
    exit 1
    ;;
esac
